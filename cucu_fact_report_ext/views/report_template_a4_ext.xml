<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) 2026 Largotek SRL -->
<!-- Extension module for cucu_fact_report -->
<odoo>
    <data>
        <!-- Extensión del reporte A4 para mostrar nombre del producto con variantes (sin código) -->
        <template id="report_a4_product_name_only" inherit_id="cucu_fact_report.cucu_report_a4">
            
            <!-- Reemplazar el contenido de descripción para mostrar nombre + variantes sin código -->
            <xpath expr="//div[@id='invoice_sale']//table//tbody//tr//td[4]//div" position="replace">
                <div>
                    <t t-set="product_code" t-value="line.get('codigoProducto', '')"/>
                    <t t-set="invoice_line" t-value="False"/>
                    
                    <!-- Intentar encontrar por código de producto -->
                    <t t-if="product_code and o.invoice_line_ids">
                        <t t-set="invoice_line" t-value="o.invoice_line_ids.filtered(lambda l: l.product_id and l.product_id.default_code == product_code)[:1]"/>
                    </t>
                    
                    <!-- Si no se encuentra por código, intentar por descripción parcial -->
                    <t t-if="not invoice_line and o.invoice_line_ids">
                        <t t-set="desc_search" t-value="line.get('descripcion', '').strip()"/>
                        <t t-if="desc_search">
                            <t t-set="invoice_line" t-value="o.invoice_line_ids.filtered(lambda l: l.product_id and desc_search in l.name)[:1]"/>
                        </t>
                    </t>
                    
                    <!-- Mostrar nombre sin código si se encontró la línea -->
                    <t t-if="invoice_line and invoice_line.product_id">
                        <!-- Obtener nombre del template del producto + atributos de variante -->
                        <t t-set="product" t-value="invoice_line.product_id"/>
                        <t t-set="product_template" t-value="product.product_tmpl_id"/>
                        
                        <!-- Nombre base del producto -->
                        <t t-esc="product_template.name"/>
                        
                        <!-- Agregar atributos de variante si existen -->
                        <t t-if="product.product_template_variant_value_ids">
                            <t t-set="variant_values" t-value="', '.join(product.product_template_variant_value_ids.mapped('name'))"/>
                            <t t-if="variant_values">
                                (<t t-esc="variant_values"/>)
                            </t>
                        </t>
                    </t>
                    <t t-else="">
                        <t t-esc="line.get('descripcion', '')"/>
                    </t>
                </div>
            </xpath>
            
        </template>

        <!-- Formatear todos los montos del footer con 2 decimales -->
        <template id="report_a4_format_totals" inherit_id="cucu_fact_report.cucu_report_a4">
            
            <!-- SUB TOTAL Bs -->
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[1]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoTotal', 0))"/>
            </xpath>
            
            <!-- DESCUENTO Bs -->
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[2]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('descuentoAdicional', 0))"/>
            </xpath>
            
            <!-- TOTAL Bs -->
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[3]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoTotalMoneda', 0))"/>
            </xpath>
            
            <!-- MONTO GIFT CARD Bs -->
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[4]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoGiftCard', 0))"/>
            </xpath>
            
            <!-- MONTO A PAGAR Bs -->
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[5]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoTotalSujetoIva', 0))"/>
            </xpath>
            
            <!-- IMPORTE BASE CRÉDITO FISCAL -->
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[6]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoTotalSujetoIva', 0))"/>
            </xpath>
            
        </template>

    </data>
</odoo>

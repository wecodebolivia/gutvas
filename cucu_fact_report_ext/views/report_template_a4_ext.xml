<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) 2026 Largotek SRL -->
<odoo>
    <data>
        <!-- Heredamos el reporte A4 de CUCU -->
        <template id="report_a4_product_name_only" inherit_id="cucu_fact_report.cucu_report_a4">
            
            <!-- FIX: REEMPLAZO DE TELÉFONO (Ignora header['telefono'] y usa Branch Office) -->
            <xpath expr="//div[@class='flex flex-col w-full']//div[5]" position="replace">
                <div class="text-sm">
                    <!-- Buscamos el teléfono en el Branch vinculado al Punto de Venta de la factura -->
                    <t t-if="o.pos_id and o.pos_id.branch_id and o.pos_id.branch_id.phone">
                        <t t-esc="o.pos_id.branch_id.phone"/>
                    </t>
                    <t t-elif="header.get('telefono')">
                        <t t-esc="header['telefono']"/>
                    </t>
                </div>
            </xpath>

            <!-- Reemplazar el contenido de descripción para mostrar nombre + variantes sin código -->
            <xpath expr="//div[@id='invoice_sale']//table//tbody//tr//td[4]//div" position="replace">
                <div>
                    <t t-set="product_code" t-value="line.get('codigoProducto', '')"/>
                    <t t-set="invoice_line" t-value="False"/>
                    <t t-if="product_code and o.invoice_line_ids">
                        <t t-set="invoice_line" t-value="o.invoice_line_ids.filtered(lambda l: l.product_id and l.product_id.default_code == product_code)[:1]"/>
                    </t>
                    <t t-if="not invoice_line and o.invoice_line_ids">
                        <t t-set="desc_search" t-value="line.get('descripcion', '').strip()"/>
                        <t t-if="desc_search">
                            <t t-set="invoice_line" t-value="o.invoice_line_ids.filtered(lambda l: l.product_id and desc_search in l.name)[:1]"/>
                        </t>
                    </t>
                    <t t-if="invoice_line and invoice_line.product_id">
                        <t t-set="product" t-value="invoice_line.product_id"/>
                        <t t-esc="product.product_tmpl_id.name"/>
                        <t t-if="product.product_template_variant_value_ids">
                            (<t t-esc="', '.join(product.product_template_variant_value_ids.mapped('name'))"/>)
                        </t>
                    </t>
                    <t t-else="">
                        <t t-esc="line.get('descripcion', '')"/>
                    </t>
                </div>
            </xpath>
        </template>

        <!-- Formatear totales con 2 decimales -->
        <template id="report_a4_format_totals" inherit_id="cucu_fact_report.cucu_report_a4">
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[1]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoTotal', 0))"/>
            </xpath>
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[3]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoTotalMoneda', 0))"/>
            </xpath>
            <xpath expr="//div[@id='invoice_sale']//tfoot//tr[5]//td[last()]//div" position="replace">
                <div t-esc="'%.2f' % float(header.get('montoTotalSujetoIva', 0))"/>
            </xpath>
        </template>
    </data>
</odoo>
